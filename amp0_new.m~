function [x, ampsim_tau2, ampsim_MSE] = amp0_new(A, y, x_true, inter_max)

[M, N] = size(A);
delta = M/N;
ampsim_tau2 = zeros(inter_max, 1);
ampsim_MSE = zeros(inter_max, 1);

z(1) = y;
x(1) = zeros(N,1);
xtm1 = x;

tau2 = 1/M*(norm(z,2)^2);

% figure
ampsim_tau2(1) = tau2;
ampsim_MSE(1) = norm(x_true - x,2).^2/N;

for t=2:inter_max

    eta_prime = 1/N * nnz(wthresh(A'*z(t-1) + x(t),'s',sqrt(tau2(t-1))));
    tau2(t) = tau2(t-1)/delta * eta_prime;
    
    eta_prime = 1/N * nnz(wthresh(A'*z(t-1) + x(t-1),'s',sqrt(tau2_tm1)));
    z = y - A*x(t) + 1/delta * z(t-1) * eta_prime;
    
    xtm1 = x;
    x = wthresh(A'*z + x,'s',sqrt(tau2));

    
    ampsim_tau2(t+1) = tau2;
    ampsim_MSE(t+1) = norm(x_true - x,2).^2/N;
    
    if(t == 10)
        unthresholded_estimate = A'*z + x;
    end
        
%     stem(x);
%     hold on
%     stem(x_true,'r')
%     hold off
%     drawnow;
%     pause;
    fprintf('AMP MSE = %f \n', 10*log10(ampsim_MSE(t+1)));
    
end

MSE = 10*log10(norm(x_true - x,2).^2/N);
fprintf('AMP final MSE = %f ', MSE);
